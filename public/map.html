<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seguimiento GPS DMD</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: "Poppins", sans-serif;
      background-color: #f8f8f8;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 999;
    }
    #toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #00897b;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      z-index: 1000;
      transition: background 0.2s;
    }
    #toggle:hover {
      background: #00695c;
    }
  </style>
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <button id="toggle">Mostrar info</button>
  <div id="info">Esperando se√±al GPS...</div>
  <div id="map"></div>

  <script>
    const userId = "cesar"; // üëà cambia si usas otro usuario
    const apiBase = window.location.origin; // usa el mismo dominio (Render)
    let map, marker, accuracyCircle;
    let showInfo = false;
    const info = document.getElementById("info");
    const toggle = document.getElementById("toggle");

    toggle.addEventListener("click", () => {
      showInfo = !showInfo;
      info.style.display = showInfo ? "block" : "none";
      toggle.textContent = showInfo ? "Ocultar info" : "Mostrar info";
    });

    function initMap(lat, lon) {
      map = L.map("map").setView([lat, lon], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap",
      }).addTo(map);
      marker = L.marker([lat, lon]).addTo(map);
      accuracyCircle = L.circle([lat, lon], { radius: 20, color: "#00897b" }).addTo(map);
    }

    async function updatePosition() {
      try {
        const res = await fetch(`${apiBase}/api/latest?userId=${userId}`);
        const data = await res.json();
        const pos = data.latest;
        if (!pos) return;

        const { lat, lon, acc, ts } = pos;
        const date = new Date(ts).toLocaleTimeString();

        if (!map) initMap(lat, lon);

        marker.setLatLng([lat, lon]);
        accuracyCircle.setLatLng([lat, lon]);
        accuracyCircle.setRadius(acc || 15);
        map.panTo([lat, lon]);

        if (showInfo) {
          info.innerHTML = `
            <b>üìç Coordenadas:</b><br>
            Lat: ${lat.toFixed(6)}<br>
            Lon: ${lon.toFixed(6)}<br>
            Precisi√≥n: ${acc || "N/A"} m<br>
            üïí ${date}
          `;
        }
      } catch (e) {
        console.error("Error al actualizar posici√≥n:", e);
      }
    }

    updatePosition();
    setInterval(updatePosition, 15000); // cada 15 segundos
  </script>
</body>
</html>
